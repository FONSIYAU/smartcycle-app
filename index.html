<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCycle V7.3 Mobile</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial', sans-serif; }
        #canvas-layer { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        
        /* Â∫ïÈÉ®ÊéßÂà∂Âå∫ */
        .ui-container { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 10; pointer-events: none; }
        .btn-group { display: flex; gap: 15px; pointer-events: auto; }
        
        button { background: rgba(0, 0, 0, 0.6); border: 2px solid #0f0; color: #fff; padding: 12px 25px; font-size: 16px; border-radius: 50px; font-weight: bold; backdrop-filter: blur(5px); }
        button:disabled { border-color: #555; color: #888; }
        button.recording { background: #f00; border-color: #fff; animation: pulse 1s infinite; }
        
        .status { color: #0f0; font-size: 12px; text-shadow: 1px 1px 2px black; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <video id="video-source" playsinline autoplay muted style="display:none;"></video>
    <canvas id="canvas-layer"></canvas>

    <div class="ui-container">
        <div id="status-text" class="status">Á≠âÂæÖGPSÂÆö‰Ωç...</div>
        <div class="btn-group">
            <button id="btn-connect">üì° ËøûÊé•</button>
            <button id="btn-cam">üì∑ Áõ∏Êú∫</button>
            <button id="btn-rec" disabled>‚è∫ ÂΩïÂà∂</button>
        </div>
    </div>

<script>
    const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const CHAR_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

    let bleDevice, bleServer;
    let latestFrame = { time:0, freq:0, vol:0, btn:0 }; 
    let gpsSpeed = 0.0; 
    let gpsAcc = 0;
    let isRecording = false;
    let mediaRecorder;
    let recordedChunks = [];
    let csvBuffer = "Time_ms,Ax,Ay,Az,Motor_Hz,Voltage_V,GPS_Speed_kmh\n";

    const video = document.getElementById('video-source');
    const canvas = document.getElementById('canvas-layer');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status-text');

    // GPS
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition((pos) => {
            let s = pos.coords.speed; 
            gpsSpeed = (s === null) ? 0 : s * 3.6; 
            gpsAcc = pos.coords.accuracy;
            statusDiv.innerText = `GPSÁ≤æÂ∫¶: ¬±${gpsAcc.toFixed(0)}m`;
        }, (err) => { console.warn(err); }, { enableHighAccuracy: true, maximumAge: 0 });
    }

    // ËìùÁâô
    document.getElementById('btn-connect').onclick = async () => {
        try {
            bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: "SmartCycle" }],
                optionalServices: [SERVICE_UUID]
            });
            bleDevice.addEventListener('gattserverdisconnected', () => {
                document.getElementById('btn-connect').style.display = 'block';
                statusDiv.innerText = "‚ö†Ô∏è ËìùÁâôÊñ≠ÂºÄ";
            });
            bleServer = await bleDevice.gatt.connect();
            const service = await bleServer.getPrimaryService(SERVICE_UUID);
            const char = await service.getCharacteristic(CHAR_UUID);
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', handleData);
            document.getElementById('btn-connect').style.display = 'none';
            statusDiv.innerText = "‚úÖ Â∑≤ËøûÊé•";
        } catch (e) { alert("Err: " + e); }
    };

    function handleData(event) {
        const val = new TextDecoder().decode(event.target.value);
        const parts = val.split(',');
        if(parts.length >= 6) {
            let t = parts[0];
            let ax = parts[1];
            let ay = parts[2];
            let az = parts[3];
            let freq = parseFloat(parts[4]);
            let vol = parseFloat(parts[5]);
            // let btn = parseInt(parts[6]); // ÊóßÁâàÂèØËÉΩÊúâÊåâÈíÆÔºåËøôÈáåÊöÇ‰∏çÈúÄË¶Å

            if(isRecording) {
                csvBuffer += `${t},${ax},${ay},${az},${freq},${vol},${gpsSpeed.toFixed(2)}\n`;
            }
            latestFrame.time = t;
            latestFrame.freq = freq;
            latestFrame.vol = vol;
        }
    }

    // Áõ∏Êú∫ (‰ΩéÁîªË¥®)
    document.getElementById('btn-cam').onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } } 
            });
            video.srcObject = stream;
            video.play();
            loopDraw();
            document.getElementById('btn-cam').style.display = 'none';
            document.getElementById('btn-rec').disabled = false;
        } catch (e) { alert("Áõ∏Êú∫Â§±Ë¥•: " + e); }
    };

    // --- UI Ê∏≤Êüì (Á´ñÂ±è‰ºòÂåñÁâà) ---
    function loopDraw() {
        if (canvas.width !== video.videoWidth) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        ctx.drawImage(video, 0, 0);

        // È°∂ÈÉ® HUD ËÉåÊôØÈªëÊù° (Âä†È´ò)
        ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
        ctx.fillRect(0, 0, canvas.width, 150);

        // --- Â∑¶‰æßÔºöÁîµÊú∫Êï∞ÊçÆ (Â†ÜÂè†ÊòæÁ§∫) ---
        ctx.textAlign = "left";
        
        // 1. È¢ëÁéá (ÈùíËâ≤)
        ctx.fillStyle = "#0ff";
        ctx.font = "bold 36px Arial"; 
        ctx.fillText(latestFrame.freq.toFixed(0), 20, 50);
        ctx.font = "14px Arial";
        ctx.fillText("Hz", 85, 50);

        // 2. ÁîµÂéã (ÁôΩËâ≤)
        ctx.fillStyle = "#fff";
        ctx.font = "bold 24px Arial";
        ctx.fillText("‚ö° " + latestFrame.vol.toFixed(2) + " V", 20, 90);

        // 3. Êó∂Èó¥Á†Å (ÈªÑËâ≤)
        ctx.fillStyle = "yellow";
        ctx.font = "16px Courier New";
        ctx.fillText("T: " + latestFrame.time, 20, 130);


        // --- Âè≥‰æßÔºöGPSÊï∞ÊçÆ (Èù†Âè≥ÂØπÈΩê) ---
        ctx.textAlign = "right";

        // GPS ÈÄüÂ∫¶ (ÁªøËâ≤Â§ßÂ≠ó)
        ctx.fillStyle = "#0f0";
        ctx.font = "bold 60px Arial";
        // ÁïôÂá∫ 30px ËæπË∑ùÔºåÈò≤Ê≠¢Ë¥¥Ëæπ
        ctx.fillText(gpsSpeed.toFixed(1), canvas.width - 30, 70);
        
        ctx.fillStyle = "#aaa";
        ctx.font = "16px Arial";
        ctx.fillText("GPS KM/H", canvas.width - 30, 100);

        // ÂΩïÂà∂Á∫¢Ê°Ü
        if (isRecording) {
            ctx.lineWidth = 5;
            ctx.strokeStyle = "rgba(255, 0, 0, 0.5)";
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
        }

        requestAnimationFrame(loopDraw);
    }

    // ÂΩïÂà∂
    document.getElementById('btn-rec').onclick = () => {
        if (!isRecording) {
            let stream = canvas.captureStream(30);
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm', bitsPerSecond: 1000000 });
            recordedChunks = [];
            csvBuffer = "Time_ms,Ax,Ay,Az,Motor_Hz,Voltage_V,GPS_Speed_kmh\n";
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = saveFiles;
            mediaRecorder.start();
            isRecording = true;
            document.getElementById('btn-rec').innerText = "‚èπ ÂÅúÊ≠¢";
            document.getElementById('btn-rec').classList.add('recording');
        } else {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById('btn-rec').innerText = "‚è∫ ÂΩïÂà∂";
            document.getElementById('btn-rec').classList.remove('recording');
        }
    };

    function saveFiles() {
        const timeStr = new Date().toISOString().slice(11,19).replace(/:/g,"-");
        const aVid = document.createElement('a');
        aVid.href = URL.createObjectURL(new Blob(recordedChunks, {type:'video/webm'}));
        aVid.download = `cycle_v73_${timeStr}.webm`; aVid.click();
        const aCsv = document.createElement('a');
        aCsv.href = URL.createObjectURL(new Blob([csvBuffer], {type:'text/csv;charset=utf-8;'}));
        aCsv.download = `cycle_data_${timeStr}.csv`; aCsv.click();
    }
</script>
</body>
</html>
