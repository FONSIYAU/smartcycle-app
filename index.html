<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCycle Remote Control</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial', sans-serif; }
        #canvas-layer { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        
        /* é¡¶éƒ¨æ•°æ®æ˜¾ç¤ºåŒº */
        .hud-top { position: absolute; top: 0; left: 0; width: 100%; height: 150px; background: rgba(0,0,0,0.6); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; pointer-events: none; z-index: 5;}
        .hud-value { font-size: 40px; font-weight: bold; color: #0ff; }
        .hud-label { font-size: 14px; color: #aaa; }
        
        /* åº•éƒ¨æ§åˆ¶åŒº */
        .control-panel { position: absolute; bottom: 20px; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 10; }
        
        /* é˜»åŠ›æŒ‰é’®ç»„ */
        .mode-group { display: flex; gap: 10px; background: rgba(50,50,50,0.8); padding: 10px; border-radius: 20px; }
        .mode-btn { width: 80px; height: 60px; border: 2px solid #555; background: #333; color: #fff; border-radius: 10px; font-size: 14px; cursor: pointer; }
        .mode-btn.active { border-color: #0f0; background: #006400; box-shadow: 0 0 10px #0f0; }

        /* è¿æ¥æŒ‰é’® */
        #btn-connect { background: rgba(0, 0, 200, 0.8); border: 1px solid #fff; color: #fff; padding: 8px 20px; border-radius: 20px; }
    </style>
</head>
<body>
    <video id="video-source" playsinline autoplay muted style="display:none;"></video>
    <canvas id="canvas-layer"></canvas>

    <!-- é¡¶éƒ¨ HUD -->
    <div class="hud-top">
        <div id="disp-power" class="hud-value">0.00 W</div>
        <div class="hud-label">å‘ç”µåŠŸç‡ (POWER)</div>
        <div style="height: 10px;"></div>
        <div id="disp-current" style="font-size: 20px; color: #fff;">0.00 A</div>
        <div class="hud-label">ç”µæµ (CURRENT)</div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶ -->
    <div class="control-panel">
        <!-- é˜»åŠ›æ§åˆ¶æŒ‰é’® -->
        <div class="mode-group">
            <button id="mode-0" class="mode-btn active" onclick="setMode('0')">æ— é˜»åŠ›<br>(OFF)</button>
            <button id="mode-1" class="mode-btn" onclick="setMode('1')">ä¸­é˜»åŠ›<br>(50%)</button>
            <button id="mode-2" class="mode-btn" onclick="setMode('2')">å¼ºé˜»åŠ›<br>(MAX)</button>
        </div>
        
        <button id="btn-connect">ğŸ“¡ è¿æ¥è“ç‰™ (SmartCycle)</button>
    </div>

<script>
    const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const CHAR_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

    let bleDevice, bleServer, bleChar;
    let currentMode = 0;

    // ç›¸æœºèƒŒæ™¯
    const video = document.getElementById('video-source');
    const canvas = document.getElementById('canvas-layer');
    const ctx = canvas.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
        video.srcObject = stream; video.play(); loopDraw();
    });

    function loopDraw() {
        if (canvas.width !== video.videoWidth) { canvas.width = video.videoWidth; canvas.height = video.videoHeight; }
        ctx.drawImage(video, 0, 0);
        requestAnimationFrame(loopDraw);
    }

    // è“ç‰™è¿æ¥
    document.getElementById('btn-connect').onclick = async () => {
        try {
            bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: "SmartCycle" }],
                optionalServices: [SERVICE_UUID]
            });
            bleDevice.addEventListener('gattserverdisconnected', () => {
                document.getElementById('btn-connect').style.display = 'block';
                alert("è“ç‰™å·²æ–­å¼€");
            });
            bleServer = await bleDevice.gatt.connect();
            const service = await bleServer.getPrimaryService(SERVICE_UUID);
            bleChar = await service.getCharacteristic(CHAR_UUID);
            
            // å¼€å¯é€šçŸ¥ (æ¥æ”¶æ•°æ®)
            await bleChar.startNotifications();
            bleChar.addEventListener('characteristicvaluechanged', handleData);
            
            document.getElementById('btn-connect').style.display = 'none';
        } catch (e) { alert("Err: " + e); }
    };

    // å‘é€æŒ‡ä»¤ (æ§åˆ¶é˜»åŠ›)
    window.setMode = async (cmd) => {
        if (!bleChar) return;
        try {
            let encoder = new TextEncoder();
            await bleChar.writeValue(encoder.encode(cmd));
            
            // æ›´æ–°æŒ‰é’® UI
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-' + cmd).classList.add('active');
        } catch(e) { console.log(e); }
    };

    // æ¥æ”¶æ•°æ® (æ˜¾ç¤ºåŠŸç‡)
    function handleData(event) {
        const val = new TextDecoder().decode(event.target.value);
        const parts = val.split(',');
        if(parts.length >= 7) {
            let power = parseFloat(parts[4]);
            let current = parseFloat(parts[5]);
            let mode = parseInt(parts[6]); // ESP32 è¿”å›çš„å½“å‰æ¨¡å¼ç¡®è®¤
            
            document.getElementById('disp-power').innerText = power.toFixed(2) + " W";
            document.getElementById('disp-current').innerText = current.toFixed(2) + " A";
            
            // åŒæ­¥æŒ‰é’®çŠ¶æ€ (ä»¥é˜²ä¸‡ä¸€)
            // document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            // document.getElementById('mode-' + mode).classList.add('active');
        }
    }
</script>
</body>
</html>
