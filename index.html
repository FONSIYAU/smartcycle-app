<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCycle GPS Calibration</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        #canvas-layer { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        .ui-container { position: absolute; bottom: 20px; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 10; pointer-events: none; }
        .btn-group { display: flex; gap: 15px; pointer-events: auto; }
        button { background: rgba(0, 100, 0, 0.8); border: 2px solid #0f0; color: #fff; padding: 10px 20px; font-size: 16px; border-radius: 8px; font-weight: bold; }
        button:disabled { border-color: #555; color: #888; background: rgba(50,50,50,0.8); }
        button.recording { background: #f00; border-color: #fff; animation: pulse 1s infinite; }
        .status { color: #0f0; font-size: 12px; background: rgba(0,0,0,0.5); padding: 4px; }
        #debug-log { position: absolute; top: 0; left: 0; width: 100%; color: yellow; font-size: 10px; background: rgba(0,0,0,0.5); padding: 5px; z-index: 20; pointer-events: none; word-wrap: break-word; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="debug-log">Debug: ç­‰å¾…è“ç‰™è¿æ¥...</div>
    <video id="video-source" playsinline autoplay muted style="display:none;"></video>
    <canvas id="canvas-layer"></canvas>

    <div class="ui-container">
        <div id="status-text" class="status">æ­£åœ¨æœç´¢GPS...</div>
        <div class="btn-group">
            <button id="btn-connect">ğŸ“¡ è¿è“ç‰™</button>
            <button id="btn-cam">ğŸ“· å¼€ç›¸æœº</button>
            <button id="btn-rec" disabled>âº å½•åˆ¶</button>
        </div>
    </div>

<script>
    const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const CHAR_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

    let bleDevice, bleServer;
    // æ•°æ®æ± : åŒ…å« ESP32 çš„ç”µå‹ å’Œ æ‰‹æœºçš„ GPS
    let data = { ax:0, ay:0, az:0, vol:0, btn:0, time:0 }; 
    let gpsSpeed = 0.0; 
    let gpsAcc = 0;

    let isRecording = false;
    let mediaRecorder;
    let recordedChunks = [];
    // CSVè¡¨å¤´: æ—¶é—´,åŠ é€Ÿåº¦X,Y,Z,ç”µæœºç”µå‹,GPSé€Ÿåº¦,æŒ‰é”®æ ‡è®°
    let csvContent = "Time_ms,Ax,Ay,Az,Voltage_V,GPS_Speed_kmh,Button_Marker\n";

    const video = document.getElementById('video-source');
    const canvas = document.getElementById('canvas-layer');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status-text');
    const debugDiv = document.getElementById('debug-log');

    // --- 0. å¯åŠ¨æ‰‹æœº GPS ---
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition((position) => {
            let s = position.coords.speed; 
            // æ‰‹æœº GPS è¿”å›çš„æ˜¯ m/sï¼Œéœ€è¦è½¬æˆ km/h
            // å¦‚æœé™æ­¢æ—¶ s å¯èƒ½æ˜¯ nullï¼Œè¿™æ—¶å€™å¼ºåˆ¶ä¸º 0
            gpsSpeed = (s === null) ? 0 : s * 3.6; 
            gpsAcc = position.coords.accuracy;
            statusDiv.innerText = `GPSç²¾åº¦: Â±${gpsAcc.toFixed(0)}m`;
        }, (err) => {
            console.warn("GPS Error:", err);
            statusDiv.innerText = "âš ï¸ æ— æ³•è·å–GPS";
        }, {
            enableHighAccuracy: true, 
            maximumAge: 0
        });
    }

    // --- 1. è“ç‰™è¿æ¥ ---
    document.getElementById('btn-connect').onclick = async () => {
        try {
            statusDiv.innerText = "æœç´¢ SmartCycle_Pro...";
            bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: "SmartCycle" }],
                optionalServices: [SERVICE_UUID]
            });
            bleDevice.addEventListener('gattserverdisconnected', () => {
                statusDiv.innerText = "âš ï¸ è“ç‰™æ–­å¼€";
                document.getElementById('btn-connect').style.display = 'block';
            });
            bleServer = await bleDevice.gatt.connect();
            const service = await bleServer.getPrimaryService(SERVICE_UUID);
            const char = await service.getCharacteristic(CHAR_UUID);
            
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', handleData);
            
            document.getElementById('btn-connect').style.display = 'none';
        } catch (e) { alert("è“ç‰™é”™è¯¯: " + e); }
    };

    // --- 2. æ•°æ®å¤„ç†ä¸èåˆ ---
    function handleData(event) {
        const val = new TextDecoder().decode(event.target.value);
        // è°ƒè¯•çª—æ˜¾ç¤ºï¼šåŸå§‹ç”µå‹ + GPSé€Ÿåº¦
        debugDiv.innerText = `ESP: ${val} | GPS: ${gpsSpeed.toFixed(1)} km/h`;
        
        const parts = val.split(',');
        // V5.2 æ ¼å¼: Time, Ax, Ay, Az, Voltage, Button
        if(parts.length >= 6) {
            data.time = parts[0];
            data.ax = parseFloat(parts[1]);
            data.ay = parseFloat(parts[2]);
            data.az = parseFloat(parts[3]);
            data.vol = parseFloat(parts[4]); // è¿™é‡Œæ˜¯ç”µå‹ï¼
            data.btn = parseInt(parts[5]);

            if(isRecording) {
                // å†™å…¥ä¸€è¡Œæ•°æ® (èåˆ ESP32 å’Œ GPS)
                csvContent += `${data.time},${data.ax},${data.ay},${data.az},${data.vol},${gpsSpeed.toFixed(2)},${data.btn}\n`;
            }
        }
    }

    // --- 3. ç»˜å›¾å¾ªç¯ ---
    document.getElementById('btn-cam').onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: {ideal: 1280}, height: {ideal: 720} } 
        });
        video.srcObject = stream;
        video.play();
        loopDraw();
        document.getElementById('btn-cam').style.display = 'none';
        document.getElementById('btn-rec').disabled = false;
    };

    function loopDraw() {
        if (canvas.width !== video.videoWidth) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        ctx.drawImage(video, 0, 0);

        // é»‘è‰²åŠé€æ˜åº•æ¡†
        ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
        ctx.fillRect(10, canvas.height - 150, 300, 140);

        // æ˜¾ç¤º GPS é€Ÿåº¦ (å¤§å­—)
        ctx.fillStyle = "#0f0";
        ctx.font = "bold 50px Courier New";
        ctx.fillText(gpsSpeed.toFixed(1), 30, canvas.height - 80);
        ctx.font = "20px Arial";
        ctx.fillStyle = "#aaa";
        ctx.fillText("KM/H (GPS)", 160, canvas.height - 80);
        
        // æ˜¾ç¤º ç”µæœºç”µå‹ (å°å­—)
        ctx.font = "20px Arial";
        ctx.fillStyle = "#fff";
        ctx.fillText(`âš¡ ${data.vol.toFixed(2)} V`, 30, canvas.height - 40);
        
        // æ˜¾ç¤º Gå€¼
        ctx.fillText(`G: ${data.ax.toFixed(2)}`, 160, canvas.height - 40);

        // æŒ‰é”®æ ‡è®° (çº¢å—)
        if (data.btn === 1) {
            ctx.fillStyle = "red";
            ctx.fillRect(canvas.width - 60, 20, 40, 40);
        }
        requestAnimationFrame(loopDraw);
    }

    // --- 4. å½•åˆ¶ä¸å¯¼å‡º ---
    document.getElementById('btn-rec').onclick = () => {
        if (!isRecording) {
            let stream = canvas.captureStream(30);
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            recordedChunks = [];
            csvContent = "Time_ms,Ax,Ay,Az,Voltage_V,GPS_Speed_kmh,Button_Marker\n";
            
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = saveFiles;
            
            mediaRecorder.start();
            isRecording = true;
            document.getElementById('btn-rec').innerText = "â¹ åœæ­¢å¹¶ä¿å­˜";
            document.getElementById('btn-rec').classList.add('recording');
        } else {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById('btn-rec').innerText = "âº å½•åˆ¶";
            document.getElementById('btn-rec').classList.remove('recording');
        }
    };

    function saveFiles() {
        const timeStr = new Date().toISOString().slice(11,19).replace(/:/g,"-");
        // ä¿å­˜è§†é¢‘
        const aVid = document.createElement('a');
        aVid.href = URL.createObjectURL(new Blob(recordedChunks, {type:'video/webm'}));
        aVid.download = `cycle_gps_${timeStr}.webm`; aVid.click();
        // ä¿å­˜æ•°æ®
        const aCsv = document.createElement('a');
        aCsv.href = URL.createObjectURL(new Blob([csvContent], {type:'text/csv;charset=utf-8;'}));
        aCsv.download = `cycle_data_${timeStr}.csv`; aCsv.click();
        
        alert("ä¸‹è½½å·²è§¦å‘ï¼");
    }
</script>
</body>
</html>
