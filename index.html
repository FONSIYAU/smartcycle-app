<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SmartCycle Mission Control</title>
  <style>
    body { margin: 0; background: #000; overflow: hidden; font-family: Arial, sans-serif; }
    #canvas-layer { position: absolute; width: 100%; height: 100%; object-fit: cover; }

    .hud-top {
      position: absolute; top: 0; left: 0; width: 100%;
      background: rgba(0,0,0,0.6); padding: 10px 0;
      color: white; display: grid; grid-template-columns: 1fr 1fr;
      text-align: center; z-index: 5;
    }
    .hud-val { font-size: 24px; font-weight: bold; }
    .hud-lbl { font-size: 10px; color: #aaa; }
    .hud-gps { color: #0f0; }
    .hud-pwr { color: #0ff; }

    .hud-sub {
      position: absolute;
      top: 96px;
      left: 0;
      width: 100%;
      z-index: 6;
      display: flex;
      justify-content: center;
      pointer-events: none;
    }
    .hud-pill {
      pointer-events: none;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      display: inline-flex;
      gap: 10px;
      align-items: center;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #666; display: inline-block; }
    .dot.ok { background: #0f0; }
    .dot.bad { background: #f00; }

    .control-panel {
      position: absolute; bottom: 20px; left: 0; width: 100%;
      display: flex; flex-direction: column; align-items: center; gap: 10px;
      z-index: 10;
    }
    .mode-group { display: flex; gap: 10px; background: rgba(50,50,50,0.8); padding: 5px; border-radius: 20px; }
    .mode-btn { padding: 10px 15px; border: 1px solid #555; background: #222; color: #fff; border-radius: 10px; font-size: 12px; }
    .mode-btn.active { background: #006400; border-color: #0f0; }
    .mode-btn:disabled { opacity: 0.4; }

    .main-btn { background: #f00; border: 2px solid #fff; color: #fff; padding: 10px 30px; font-size: 16px; border-radius: 50px; font-weight: bold; }
    .connect-btn { background: blue; border: none; }
  </style>
</head>
<body>
  <video id="video-source" playsinline autoplay muted style="display:none;"></video>
  <canvas id="canvas-layer"></canvas>

  <div class="hud-top">
    <div>
      <div id="val-gps" class="hud-val hud-gps">0.0</div>
      <div class="hud-lbl">GPS KM/H</div>
    </div>
    <div>
      <div id="val-freq" class="hud-val">0</div>
      <div class="hud-lbl">MOTOR HZ</div>
    </div>
    <div>
      <div id="val-power" class="hud-val hud-pwr">0.00</div>
      <div class="hud-lbl">WATTS</div>
    </div>
    <div>
      <div id="val-time" class="hud-val">0</div>
      <div class="hud-lbl">TIME CODE</div>
    </div>
  </div>

  <div class="hud-sub">
    <div class="hud-pill">
      <span id="conn-dot" class="dot bad"></span>
      <span id="conn-text">æœªè¿æ¥</span>
      <span>MODE:</span><span id="mode-text">-</span>
      <span>LAST:</span><span id="last-text">-</span>
    </div>
  </div>

  <div class="control-panel">
    <div class="mode-group">
      <button id="m0" class="mode-btn active" onclick="setMode('0')" disabled>OFF<br>æ— é˜»åŠ›</button>
      <button id="m1" class="mode-btn" onclick="setMode('1')" disabled>ECO<br>å……ç”µ</button>
      <button id="m2" class="mode-btn" onclick="setMode('2')" disabled>MAX<br>å¼ºé˜»</button>
    </div>
    <button id="btn-action" class="main-btn connect-btn">ğŸ“¡ è¿æ¥è“ç‰™</button>
  </div>

<script>
  // ====== UUIDsï¼ˆåŒ¹é…ä½ å½“å‰å›ºä»¶ï¼šå•ç‰¹å¾å€¼ 6e400003 æ—¢ notify åˆ writeï¼‰======
  const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

  // ====== BLE çŠ¶æ€ ======
  let bleDevice = null;
  let bleServer = null;
  let txChar = null;   // notify é€šé“
  let rxChar = null;   // write é€šé“ï¼ˆ= txCharï¼‰
  let rxBuffer = "";

  // ====== æ•°æ®/å½•åˆ¶ ======
  let gpsSpeed = 0.0;
  let isRecording = false;
  let mediaRecorder = null;
  let recordedChunks = [];
  let csvLines = [];
  let lastFrameMs = 0;

  // ====== UI ======
  const btnAction = document.getElementById('btn-action');
  const connDot = document.getElementById('conn-dot');
  const connText = document.getElementById('conn-text');
  const lastText = document.getElementById('last-text');
  const modeText = document.getElementById('mode-text');

  const modeButtons = ["m0","m1","m2"].map(id => document.getElementById(id));
  function setModeButtonsEnabled(on) { modeButtons.forEach(b => b.disabled = !on); }

  function setConnectedUI() {
    connDot.classList.remove("bad");
    connDot.classList.add("ok");
    connText.innerText = "å·²è¿æ¥";
    btnAction.classList.remove('connect-btn');
    btnAction.innerText = "âº å¼€å§‹å½•åˆ¶";
    setModeButtonsEnabled(true);
  }

  function setDisconnectedUI() {
    txChar = null;
    rxChar = null;
    bleServer = null;
    rxBuffer = "";

    connDot.classList.remove("ok");
    connDot.classList.add("bad");
    connText.innerText = "æœªè¿æ¥";
    lastText.innerText = "-";
    modeText.innerText = "-";

    btnAction.classList.add('connect-btn');
    btnAction.innerText = "ğŸ“¡ è¿æ¥è“ç‰™";
    setModeButtonsEnabled(false);
  }

  function attachDisconnectHandler() {
    if (!bleDevice) return;
    bleDevice.addEventListener('gattserverdisconnected', () => {
      alert("è“ç‰™æ–­å¼€");
      setDisconnectedUI();
    });
  }

  // æ¯ç§’åˆ·æ–°ä¸€ä¸‹ LAST æŒ‡ç¤ºï¼ˆå¸®ä½ åˆ¤æ–­æ˜¯å¦åœ¨æŒç»­æ”¶å¸§ï¼‰
  setInterval(() => {
    if (!lastFrameMs) return;
    const dt = Date.now() - lastFrameMs;
    lastText.innerText = (dt < 10000) ? (dt + "ms") : (Math.round(dt/1000) + "s");
  }, 500);

  // ====== GPS ======
  if ("geolocation" in navigator) {
    navigator.geolocation.watchPosition(pos => {
      const s = pos.coords.speed;
      gpsSpeed = (s === null) ? 0 : s * 3.6;
      document.getElementById('val-gps').innerText = gpsSpeed.toFixed(1);
    }, err => console.warn(err), {
      enableHighAccuracy: true,
      maximumAge: 500,
      timeout: 5000
    });
  }

  // ====== ç›¸æœºæ¸²æŸ“ ======
  const video = document.getElementById('video-source');
  const canvas = document.getElementById('canvas-layer');
  const ctx = canvas.getContext('2d');

  navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } }
  }).then(stream => {
    video.srcObject = stream;
    video.play();
    loopDraw();
  }).catch(err => {
    alert("ç›¸æœºæ‰“å¼€å¤±è´¥: " + err);
  });

  function loopDraw() {
    if (canvas.width === 0 || canvas.height === 0) {
      canvas.width = 640;
      canvas.height = 480;
    }
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    if (isRecording) {
      ctx.lineWidth = 5;
      ctx.strokeStyle = "red";
      ctx.strokeRect(0, 0, canvas.width, canvas.height);
    }
    requestAnimationFrame(loopDraw);
  }

  // ====== BLE è¿æ¥ ======
  async function connectBle() {
    try {
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: "SmartCycle" }],
        optionalServices: [SERVICE_UUID]
      });

      attachDisconnectHandler();

      bleServer = await bleDevice.gatt.connect();
      const service = await bleServer.getPrimaryService(SERVICE_UUID);

      // å•é€šé“ç‰¹å¾å€¼ï¼šæ—¢ notify åˆ write
      txChar = await service.getCharacteristic(TX_UUID);

      await txChar.startNotifications();
      txChar.addEventListener('characteristicvaluechanged', handleData);

      rxChar = txChar;

      setConnectedUI();
      alert("è¿æ¥æˆåŠŸï¼");
    } catch (e) {
      alert("è¿æ¥å¤±è´¥: " + e);
      setDisconnectedUI();
    }
  }

  btnAction.onclick = async () => {
    if (!bleDevice || !bleDevice.gatt || !bleDevice.gatt.connected) {
      await connectBle();
    } else {
      toggleRecording();
    }
  };

  // ====== æ•°æ®æ¥æ”¶ï¼šæ‹¼åŒ… + æŒ‰è¡Œè§£æ ======
  function handleData(event) {
    const chunk = new TextDecoder().decode(event.target.value);
    rxBuffer += chunk;

    let idx;
    while ((idx = rxBuffer.indexOf("\n")) >= 0) {
      const line = rxBuffer.slice(0, idx).trim();
      rxBuffer = rxBuffer.slice(idx + 1);
      if (!line) continue;

      const p = line.split(",");
      if (p.length < 8) continue;

      // p: t,ax,ay,az,freq,w,a,mode
      const t = Number(p[0]);
      const freq = Number(p[4]);
      const w = Number(p[5]);
      const mode = String(p[7]).trim();

      document.getElementById('val-freq').innerText = isFinite(freq) ? String(freq) : "-";
      document.getElementById('val-power').innerText = isFinite(w) ? w.toFixed(2) : "-";
      document.getElementById('val-time').innerText = isFinite(t) ? String(t) : "-";

      modeText.innerText = (mode === "0" || mode === "1" || mode === "2") ? mode : "?";
      lastFrameMs = Date.now();

      if (isRecording) {
        csvLines.push(`${p[0]},${p[1]},${p[2]},${p[3]},${p[4]},${p[5]},${p[6]},${p[7]},${gpsSpeed.toFixed(2)}`);
      }
    }
  }

  // ====== å‘é€æŒ‡ä»¤ï¼šä¼˜å…ˆ writeWithoutResponseï¼ˆæ›´ç¨³ï¼‰ ======
  window.setMode = async (cmd) => {
    if (!rxChar) return;
    const payload = new TextEncoder().encode(cmd);

    try {
      if (typeof rxChar.writeValueWithoutResponse === "function") {
        await rxChar.writeValueWithoutResponse(payload);
      } else {
        await rxChar.writeValue(payload);
      }

      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('m' + cmd).classList.add('active');
    } catch (e) {
      alert("å‘é€å¤±è´¥ï¼Œå¯èƒ½æ–­è¿ï¼Œè¯·é‡æ–°è¿æ¥");
      setDisconnectedUI();
    }
  };

  // ====== å½•åˆ¶ ======
  function resetCsv() {
    csvLines = ["Time_ms,Ax,Ay,Az,Motor_Hz,Watts,Amps,Mode,GPS_Kmh"];
  }

  function toggleRecording() {
    if (!isRecording) {
      const stream = canvas.captureStream(20);
      recordedChunks = [];
      resetCsv();

      mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'video/webm',
        bitsPerSecond: 800000
      });

      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = saveFiles;

      mediaRecorder.start();
      isRecording = true;
      btnAction.innerText = "â¹ åœæ­¢å¹¶ä¿å­˜";
    } else {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      } else {
        saveFiles();
      }
      isRecording = false;
      btnAction.innerText = "âº å¼€å§‹å½•åˆ¶";
    }
  }

  function saveFiles() {
    const timeStr = new Date().toISOString().slice(11, 19).replace(/:/g, "-");

    if (recordedChunks.length > 0) {
      const aVid = document.createElement('a');
      aVid.href = URL.createObjectURL(new Blob(recordedChunks, { type: 'video/webm' }));
      aVid.download = `cycle_${timeStr}.webm`;
      aVid.click();
    }

    if (csvLines.length > 1) {
      const aCsv = document.createElement('a');
      const csvBlob = new Blob([csvLines.join("\n") + "\n"], { type: 'text/csv;charset=utf-8;' });
      aCsv.href = URL.createObjectURL(csvBlob);
      aCsv.download = `cycle_${timeStr}.csv`;
      aCsv.click();
    } else {
      alert("æ²¡æœ‰å½•åˆ°CSVæ•°æ®ï¼ˆå¯èƒ½æ²¡æ”¶åˆ°å¸§ï¼‰");
    }
  }

  // åˆå§‹åŒ– UIï¼šæœªè¿æ¥
  setDisconnectedUI();
</script>
</body>
</html>
