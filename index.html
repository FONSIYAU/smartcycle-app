<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SmartCycle Mission Control</title>
  <style>
    body { margin: 0; background: #000; overflow: hidden; font-family: Arial, sans-serif; }
    #canvas-layer { position: absolute; width: 100%; height: 100%; object-fit: cover; }

    .hud-top {
      position: absolute; top: 0; left: 0; width: 100%;
      background: rgba(0,0,0,0.6); padding: 10px 0;
      color: white; display: grid; grid-template-columns: 1fr 1fr;
      text-align: center; z-index: 5;
    }
    .hud-val { font-size: 24px; font-weight: bold; }
    .hud-lbl { font-size: 10px; color: #aaa; }
    .hud-gps { color: #0f0; }
    .hud-pwr { color: #0ff; }

    .control-panel {
      position: absolute; bottom: 20px; left: 0; width: 100%;
      display: flex; flex-direction: column; align-items: center; gap: 10px;
      z-index: 10;
    }

    .mode-group { display: flex; gap: 10px; background: rgba(50,50,50,0.8); padding: 5px; border-radius: 20px; }
    .mode-btn { padding: 10px 15px; border: 1px solid #555; background: #222; color: #fff; border-radius: 10px; font-size: 12px; }
    .mode-btn.active { background: #006400; border-color: #0f0; }

    .main-btn { background: #f00; border: 2px solid #fff; color: #fff; padding: 10px 30px; font-size: 16px; border-radius: 50px; font-weight: bold; }
    .connect-btn { background: blue; border: none; }
  </style>
</head>
<body>
  <video id="video-source" playsinline autoplay muted style="display:none;"></video>
  <canvas id="canvas-layer"></canvas>

  <div class="hud-top">
    <div>
      <div id="val-gps" class="hud-val hud-gps">0.0</div>
      <div class="hud-lbl">GPS KM/H</div>
    </div>
    <div>
      <div id="val-freq" class="hud-val">0</div>
      <div class="hud-lbl">MOTOR HZ</div>
    </div>
    <div>
      <div id="val-power" class="hud-val hud-pwr">0.00</div>
      <div class="hud-lbl">WATTS</div>
    </div>
    <div>
      <div id="val-time" class="hud-val">0</div>
      <div class="hud-lbl">TIME CODE</div>
    </div>
  </div>

  <div class="control-panel">
    <div class="mode-group">
      <button id="m0" class="mode-btn active" onclick="setMode('0')">OFF<br>æ— é˜»åŠ›</button>
      <button id="m1" class="mode-btn" onclick="setMode('1')">ECO<br>å……ç”µ</button>
      <button id="m2" class="mode-btn" onclick="setMode('2')">MAX<br>å¼ºé˜»</button>
    </div>
    <button id="btn-action" class="main-btn connect-btn">ğŸ“¡ è¿æ¥è“ç‰™</button>
  </div>

<script>
  // ====== UUIDs (NUSé£æ ¼) ======
  const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // Web -> ESP32
  const TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // ESP32 -> Web

  // ====== BLE çŠ¶æ€ ======
  let bleDevice = null;
  let bleServer = null;
  let rxChar = null;
  let txChar = null;
  let rxBuffer = ""; // å…³é”®ï¼šæ‹¼åŒ…ç¼“å†²ï¼ˆæŒ‰ \n åˆ‡å¸§ï¼‰

  // ====== æ•°æ®/å½•åˆ¶ ======
  let gpsSpeed = 0.0;
  let isRecording = false;
  let mediaRecorder = null;
  let recordedChunks = [];
  let csvLines = [];

  // ====== UI ======
  const btnAction = document.getElementById('btn-action');

  function setDisconnectedUI() {
    rxChar = null;
    txChar = null;
    bleServer = null;
    rxBuffer = "";

    if (isRecording && mediaRecorder && mediaRecorder.state !== "inactive") {
      // æ–­è¿æ—¶ä¸å¼ºåˆ¶åœæ­¢å½•å±ï¼ˆä½ ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªåŠ¨ stopï¼‰
      console.warn("BLE disconnected while recording");
    }

    btnAction.classList.add('connect-btn');
    btnAction.innerText = "ğŸ“¡ è¿æ¥è“ç‰™";
  }

  function attachDisconnectHandler() {
    if (!bleDevice) return;
    bleDevice.addEventListener('gattserverdisconnected', () => {
      alert("è“ç‰™æ–­å¼€");
      setDisconnectedUI();
    });
  }

  // ====== GPS ======
  if ("geolocation" in navigator) {
    navigator.geolocation.watchPosition(pos => {
      const s = pos.coords.speed;
      gpsSpeed = (s === null) ? 0 : s * 3.6;
      document.getElementById('val-gps').innerText = gpsSpeed.toFixed(1);
    }, err => console.warn(err), {
      enableHighAccuracy: true,
      maximumAge: 500,
      timeout: 5000
    });
  }

  // ====== ç›¸æœºæ¸²æŸ“ ======
  const video = document.getElementById('video-source');
  const canvas = document.getElementById('canvas-layer');
  const ctx = canvas.getContext('2d');

  navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } }
  }).then(stream => {
    video.srcObject = stream;
    video.play();
    loopDraw();
  }).catch(err => {
    alert("ç›¸æœºæ‰“å¼€å¤±è´¥: " + err);
  });

  function loopDraw() {
    // å›ºå®šä¸€å¥—åˆ†è¾¨ç‡ï¼Œé¿å…é¢‘ç¹æ”¹canvaså°ºå¯¸é€ æˆæŠ–åŠ¨
    if (canvas.width === 0 || canvas.height === 0) {
      canvas.width = 640;
      canvas.height = 480;
    }

    // æŠŠè§†é¢‘ç”»åˆ°å›ºå®šcanvasä¸Šï¼ˆç¼©æ”¾ï¼‰
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (isRecording) {
      ctx.lineWidth = 5;
      ctx.strokeStyle = "red";
      ctx.strokeRect(0, 0, canvas.width, canvas.height);
    }

    requestAnimationFrame(loopDraw);
  }

  // ====== BLE è¿æ¥ ======
  async function connectBle() {
    // æ¯æ¬¡è¿æ¥éƒ½èµ° requestDeviceï¼ˆAndroid Chrome ä½“éªŒæœ€å¥½ï¼‰
    // ä½ ä¹Ÿå¯ä»¥æ”¹æˆå¤ç”¨ bleDevice å¹¶å°è¯• gatt.connect()ï¼Œä½†æµ‹è¯•æœºé˜¶æ®µè¿™æ ·æœ€ç›´è§‚
    try {
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: "SmartCycle" }],
        optionalServices: [SERVICE_UUID]
      });

      attachDisconnectHandler();

      bleServer = await bleDevice.gatt.connect();
      const service = await bleServer.getPrimaryService(SERVICE_UUID);

      // è®¢é˜…æ•°æ®
      txChar = await service.getCharacteristic(TX_UUID);
      await txChar.startNotifications();
      txChar.addEventListener('characteristicvaluechanged', handleData);

      // è·å–å‘é€é€šé“
      rxChar = await service.getCharacteristic(RX_UUID);

      btnAction.classList.remove('connect-btn');
      btnAction.innerText = "âº å¼€å§‹å½•åˆ¶";
      alert("è¿æ¥æˆåŠŸï¼");
    } catch (e) {
      alert("è¿æ¥å¤±è´¥: " + e);
      setDisconnectedUI();
    }
  }

  btnAction.onclick = async () => {
    // è‹¥æœªè¿æ¥æˆ–å·²æ–­è¿ï¼Œä¼˜å…ˆè¿æ¥ï¼›å¦åˆ™å¼€å§‹/åœæ­¢å½•åˆ¶
    if (!bleDevice || !bleDevice.gatt || !bleDevice.gatt.connected) {
      await connectBle();
    } else {
      toggleRecording();
    }
  };

  // ====== æ•°æ®æ¥æ”¶ï¼ˆå…³é”®ï¼šæ‹¼åŒ… + æŒ‰è¡Œè§£æï¼‰ ======
  function handleData(event) {
    const chunk = new TextDecoder().decode(event.target.value);
    rxBuffer += chunk;

    let idx;
    while ((idx = rxBuffer.indexOf("\n")) >= 0) {
      const line = rxBuffer.slice(0, idx).trim();
      rxBuffer = rxBuffer.slice(idx + 1);

      if (!line) continue;

      const p = line.split(",");
      if (p.length < 8) continue;

      // è½¬æ•°å­—ï¼ˆé¿å…å­—ç¬¦ä¸²æ±¡æŸ“ï¼‰
      const t = Number(p[0]);
      const freq = Number(p[4]);
      const w = Number(p[5]);

      document.getElementById('val-freq').innerText = isFinite(freq) ? String(freq) : "-";
      document.getElementById('val-power').innerText = isFinite(w) ? w.toFixed(2) : "-";
      document.getElementById('val-time').innerText = isFinite(t) ? String(t) : "-";

      // å½• CSVï¼ˆæ•°ç»„æ›´ç¨³ï¼Œä¸ä¼šè¶Šå½•è¶Šå¡ï¼‰
      if (isRecording) {
        csvLines.push(`${p[0]},${p[1]},${p[2]},${p[3]},${p[4]},${p[5]},${p[6]},${p[7]},${gpsSpeed.toFixed(2)}`);
      }
    }
  }

  // ====== å‘é€æŒ‡ä»¤ ======
  window.setMode = async (cmd) => {
    if (!rxChar) return;
    try {
      await rxChar.writeValue(new TextEncoder().encode(cmd));
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('m' + cmd).classList.add('active');
    } catch (e) {
      alert("å‘é€å¤±è´¥ï¼Œå¯èƒ½æ–­è¿ï¼Œè¯·é‡æ–°è¿æ¥");
      setDisconnectedUI();
    }
  };

  // ====== å½•åˆ¶ ======
  function resetCsv() {
    csvLines = ["Time_ms,Ax,Ay,Az,Motor_Hz,Watts,Amps,Mode,GPS_Kmh"];
  }

  function toggleRecording() {
    if (!isRecording) {
      // å½•å±ï¼šé™åˆ°20fps + åˆç†ç ç‡ï¼Œå‡å°‘å¯¹BLEçš„å¹²æ‰°
      const stream = canvas.captureStream(20);
      recordedChunks = [];
      resetCsv();

      mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'video/webm',
        bitsPerSecond: 800000
      });

      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = saveFiles;

      mediaRecorder.start();
      isRecording = true;
      btnAction.innerText = "â¹ åœæ­¢å¹¶ä¿å­˜";
    } else {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      } else {
        // é˜²å¾¡ï¼šå¼‚å¸¸çŠ¶æ€ä¹Ÿèƒ½ä¿å­˜CSV
        saveFiles();
      }
      isRecording = false;
      btnAction.innerText = "âº å¼€å§‹å½•åˆ¶";
    }
  }

  function saveFiles() {
    const timeStr = new Date().toISOString().slice(11, 19).replace(/:/g, "-");

    // Video
    if (recordedChunks.length > 0) {
      const aVid = document.createElement('a');
      aVid.href = URL.createObjectURL(new Blob(recordedChunks, { type: 'video/webm' }));
      aVid.download = `cycle_${timeStr}.webm`;
      aVid.click();
    }

    // CSV
    if (csvLines.length > 1) {
      const aCsv = document.createElement('a');
      const csvBlob = new Blob([csvLines.join("\n") + "\n"], { type: 'text/csv;charset=utf-8;' });
      aCsv.href = URL.createObjectURL(csvBlob);
      aCsv.download = `cycle_${timeStr}.csv`;
      aCsv.click();
    } else {
      alert("æ²¡æœ‰å½•åˆ°CSVæ•°æ®ï¼ˆå¯èƒ½æ²¡è¿ä¸ŠBLEæˆ–æœªæ”¶åˆ°å¸§ï¼‰");
    }
  }
</script>
</body>
</html>
